# 파일업로드 & 메시지 수정·삭제 트러블슈팅 요약

> 대상 스택: React(axios, STOMP) · Spring Boot(Security+JWT, STOMP) · JPA · 로컬 파일 저장(`/uploads`)
> 목적: **A4 1장 내**로, “어디서 왜 막혔고 어떻게 고쳤는지”를 정리

---

## TL;DR

* 업로드 실패의 1차 원인은 **잘못된 요청 URL 구성**(FormData가 URL에 들어감) → 프리플라이트 매칭 실패로 CORS 에러.
* 메시지 생성 500은 **`writer_nickname` 미세팅**으로 DB `NOT NULL` 제약 위반.
* 첨부 기록 500은 **`attachment.file_name` 컬럼과 엔티티 불일치**(우리는 URL만 저장) 때문.
* 메시지 수정 400은 DTO가 **`messageId`/`writerId`를 @NotNull로 요구**했기 때문(경로·토큰으로 대체해야 함).

---

## 1) 파일 업로드 문제

### 증상

* 콘솔: `Access to XMLHttpRequest ... blocked by CORS`
* 실제 요청 URL: `/api/workshops/[object%20FormData]/lounges/undefined/files`

### 원인

* `fileAPI.upload(formData)` 내부에서 **URL 템플릿에 FormData 자체를 끼워 넣는 버그**.
  경로가 실제 엔드포인트와 매칭되지 않아 **CORS 헤더가 붙지 않음**.

### 해결

* FormData는 **항상 body로만 전송**. URL은 **정적 경로** 사용.
* 최종 경로 정렬(백엔드 기준):

  * 업로드: `POST /api/messages/files` (multipart)
  * STOMP 발행: `/pub/workshops.{workshopId}.lounges.{loungeId}.send`
* axios 전송 시 **`Content-Type` 수동 설정 금지**(FormData는 브라우저가 boundary 자동 지정).
* `WebMvcConfig`에 정적 리소스 매핑: `/files/** → file:{pwd}/uploads/`.

---

## 2) 메시지 생성 500 (`writer_nickname` NULL)

### 증상

* 스프링 로그: `DataIntegrityViolationException: Column 'writer_nickname' cannot be null`

### 원인

* `MessageService.sendMessage()`가 `new Message(loungeId, writerId, content)`만 저장 → `writerNickname` 미세팅.
  (반면 `ChatSocketService`는 닉네임을 채워 저장)

### 해결

* `MessageService.sendMessage()`에서 저장 전 **닉네임 세팅**:

  * `nickname = sender.nickname != null ? sender.nickname : sender.id`
  * `m.setWriterNickname(nickname)` 후 save

---

## 3) 첨부 기록 500 (`attachment.file_name`)

### 증상

* `Column 'file_name' cannot be null` → 이후 `Field 'file_name' doesn't have a default value`

### 원인

* 정책 변경으로 **URL만 DB에 저장**하기로 했으나, DB 스키마는 여전히 `file_name NOT NULL`.

### 해결(둘 중 하나)

* **권장:** 스키마에서 `file_name` **드랍**

  ```sql
  ALTER TABLE attachment DROP COLUMN file_name;
  ```
* (대안) `file_name` **NULL 허용** 변경

  ```sql
  ALTER TABLE attachment MODIFY COLUMN file_name VARCHAR(255) NULL;
  ```
* 엔티티 `Attachment`에서도 `fileName` 필드 제거.

---

## 4) 메시지 수정 400 (Bad Request)

### 증상

* `MethodArgumentNotValidException: EditMessageRequest.messageId is null`

### 원인

* 경로에 `/{messageId}`가 있음에도, DTO가 `@NotNull messageId`/`@NotBlank writerId`를 요구 → 바디 검증에서 400.

### 해결

* **수정/삭제 컨트롤러 표준화**

  * 대상 메시지: **`@PathVariable Long messageId`**
  * 요청자: **`@AuthenticationPrincipal User principal`** (JWT) → `principal.getUsername()`
  * 바디: **변경 내용만**(예: `content`, 선택적 `fileUrl`)
* DTO 정리

  * `EditMessageRequest` → `content`(+ `fileUrl` 선택)만 유지
  * `DeleteMessageRequest`는 **삭제**(바디 없는 DELETE) 또는 빈 DTO로 optional.

---

## 5) 보안·정합성 체크리스트

* Security: `/api/messages/**`는 `authenticated()` + `jwtAuthFilter` 작동.
* axios 인터셉터: 모든 요청에 `Authorization: Bearer <token>` 자동 첨부.
* 라운지–워크샵 정합성: 업로드/수정/삭제 전 `lounge.workshopId == workshopId` 확인.
* 소유권: 수정/삭제/첨부 시 `message.writerId == principal.username`.
* 삭제 메시지 보호: 조회는 `findByIdAndIsDeletedFalse(...)` 사용.

---

## 6) 다음 단계 권장(확장 대비, 지금은 비활성화 가능)

* `Attachment`는 **타깃 다형성**(`targetType + targetId`)만 유지 → Post/Comment 확장 쉬움.
* S3 전환 시: Presigned URL 업로드 + DB엔 CDN URL만 저장.

---

### 최종 상태 요약

* 업로드: **정상**(로컬 `/uploads` 저장, URL 응답).
* 메시지 생성: **정상**(`writerNickname` 세팅).
* 수정/삭제: **정상**(PathVar + Principal 기반, DTO 정리).
